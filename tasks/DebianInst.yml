- name: Apt install influxdb
  apt: name=influxdb
  when: influxdb_use_apt

- name: Fetch package
  get_url: url={{influxdb_deb_src_url}}/influxdb_{{ influxdb_version }}_amd64.deb
           dest={{ download_tmp_dir }}/influxdb_{{ influxdb_version }}_amd64.deb
  register: get_url_result
  until: get_url_result.state == 'file'
  retries: 5
  delay: 1
  when: not influxdb_use_apt

- name: Set owner and group for influxdb package
  file:
    path="{{ download_tmp_dir }}/influxdb_{{ influxdb_version }}_amd64.deb"
    state=file
    owner={{ influx_db_user }}
    group={{ influx_db_group }}
    mode=640
  when: not influxdb_use_apt

- name: Install package
  command: dpkg --skip-same-version -i {{ download_tmp_dir }}/influxdb_{{ influxdb_version }}_amd64.deb
  register: dpkg_result
  changed_when: "dpkg_result.stdout.startswith('Selecting')"
  when: not influxdb_use_apt
